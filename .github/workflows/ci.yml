name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  eslint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx eslint src/

  biome:
    name: Biome
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx biome check src/

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run test:coverage

  typecheck:
    name: TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npx tsc -noEmit -skipLibCheck

  version-check:
    name: Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check version consistency
        run: |
          MANIFEST_VER=$(jq -r .version manifest.json)
          PACKAGE_VER=$(jq -r .version package.json)
          VERSIONS_ENTRY=$(jq -r --arg v "$MANIFEST_VER" 'has($v)' versions.json)
          CHANGELOG_ENTRY=$(grep -c "## \[$MANIFEST_VER\]" CHANGELOG.md || true)

          echo "manifest.json:  $MANIFEST_VER"
          echo "package.json:   $PACKAGE_VER"
          echo "versions.json:  entry exists = $VERSIONS_ENTRY"
          echo "CHANGELOG.md:   entries found = $CHANGELOG_ENTRY"

          FAIL=0

          if [ "$MANIFEST_VER" != "$PACKAGE_VER" ]; then
            echo "::error::Version mismatch: manifest.json ($MANIFEST_VER) != package.json ($PACKAGE_VER)"
            FAIL=1
          fi

          if [ "$VERSIONS_ENTRY" != "true" ]; then
            echo "::error::versions.json is missing entry for $MANIFEST_VER"
            FAIL=1
          fi

          if [ "$CHANGELOG_ENTRY" -eq 0 ]; then
            echo "::error::CHANGELOG.md is missing section for [$MANIFEST_VER]"
            FAIL=1
          fi

          if [ "$FAIL" -eq 1 ]; then exit 1; fi
          echo "All versions consistent: $MANIFEST_VER"
